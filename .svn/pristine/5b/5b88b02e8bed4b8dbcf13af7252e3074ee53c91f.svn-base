package com.luwei.hackvr.serviceImpl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.collections.CollectionUtils;
import org.apache.ibatis.session.RowBounds;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.luwei.hackvr.mapper.VideoMapper;
import com.luwei.hackvr.pojo.Article;
import com.luwei.hackvr.pojo.Toutiao;
import com.luwei.hackvr.pojo.Video;
import com.luwei.hackvr.pojo.VideoExample;
import com.luwei.hackvr.service.ToutiaoService;
import com.luwei.hackvr.service.VideoService;

@Service("videoService")
public class VideoServiceImpl implements VideoService {
    @Autowired
    private VideoMapper videoMapper;
    @Autowired
    private ToutiaoService toutiaoService;

    @Override
    public List<Video> getLateVideos(int index, int num) {
        VideoExample example = new VideoExample();
        example.setOrderByClause("create_time desc");
        example.createCriteria().andFlagEqualTo((byte)1);
        RowBounds rowBounds = new RowBounds(index, num);
        List<Video> videos = videoMapper.selectByExampleWithRowbounds(example, rowBounds);
        
        if (CollectionUtils.isEmpty(videos)) {
            return null;
        }
        
        return videos;
    }

    @Override
    public Video getVideoById(int id) {
        Video video = videoMapper.selectByPrimaryKey(id);
        
        return video;
    }
    
    @Override
    public List<Video> getLateVideos(int index, int num, int type) {
        List<Integer> typeList = new ArrayList<Integer>();
        if (type == 0) {
            typeList.add(0); typeList.add(36); typeList.add(40); typeList.add(41); typeList.add(42);
        } else if (type == 1) {
            typeList.add(14); typeList.add(35);
        } else if (type == 2) {
            typeList.add(1); typeList.add(2); typeList.add(3); typeList.add(4); typeList.add(5);
            typeList.add(20); typeList.add(21); typeList.add(22); typeList.add(23); typeList.add(24);
            typeList.add(25); typeList.add(26); typeList.add(30); typeList.add(31);
        } else if (type == 3) {
            typeList.add(15); typeList.add(16); typeList.add(17); typeList.add(34);
        } else if (type == 4) {
            typeList.add(11); typeList.add(12); typeList.add(13);
            typeList.add(28); typeList.add(29); typeList.add(33);
        } else if (type == 5) {
            typeList.add(6); typeList.add(7); typeList.add(8); typeList.add(9); typeList.add(10);
            typeList.add(32); typeList.add(38);
        } else if (type == 6) {
            typeList.add(18); typeList.add(19); typeList.add(27); typeList.add(37);
        }
        
        VideoExample example = new VideoExample();
        example.setOrderByClause("create_time desc");
        example.createCriteria().andFlagEqualTo((byte)1).andTypeIn(typeList);
        RowBounds rowBounds = new RowBounds(index, num);
        List<Video> videos = videoMapper.selectByExampleWithRowbounds(example, rowBounds);
        
        if (CollectionUtils.isEmpty(videos)) {
            return null;
        }
        
        return videos;
    }
    
    @Override
    public List<List<Map<String, Object>>> getShipinToutiaoVideos(int num) {
        num = num/2*2;
        List<Toutiao> toutiaos = toutiaoService.getShipinToutiaos(num);
        
        if (CollectionUtils.isEmpty(toutiaos)) {
            return null;
        }
        
        List<Map<String, Object>> retList = new ArrayList<Map<String, Object>>();
        for (Toutiao toutiao : toutiaos) {
            Map<String, Object> map = new HashMap<String, Object>();
            Video video = videoMapper.selectByPrimaryKey(toutiao.getArticleId());
            map.put("videoId", video.getVideoId());
            map.put("title", video.getTitle());
            map.put("preinfo", video.getPreinfo());
            map.put("preimage", toutiao.getImgUrl());
            map.put("videoUrl", video.getVideoUrl());
            map.put("videoLength", video.getVideoLength());
            map.put("videoClarity", video.getVideoClarity());
            map.put("clickNum", video.getClickNum());
            
            retList.add(map);
        }

        List<List<Map<String, Object>>> resList = new ArrayList<List<Map<String,Object>>>();
        for (int i = 0; i < retList.size(); i += 2) {
            resList.add(retList.subList(i, i+2));
        }
        
        return resList;
    }
    
    @Override
    public List<List<Map<String, Object>>> getRemenShipinVideos(int num) {
        VideoExample example = new VideoExample();
        example.setOrderByClause("click_num desc");
        example.createCriteria().andFlagEqualTo((byte)1);
        
        num = num/2*2;
        RowBounds rowBounds = new RowBounds(0, num);
        List<Video> videos = videoMapper.selectByExampleWithRowbounds(example, rowBounds);
        
        if (CollectionUtils.isEmpty(videos)) {
            return null;
        }
        
        List<Map<String, Object>> retList = new ArrayList<Map<String, Object>>();
        for (Video video : videos) {
            Map<String, Object> map = new HashMap<String, Object>();
            map.put("videoId", video.getVideoId());
            map.put("title", video.getTitle());
            map.put("preinfo", video.getPreinfo());
            map.put("preimage", video.getPreimage());
            map.put("videoUrl", video.getVideoUrl());
            map.put("videoLength", video.getVideoLength());
            map.put("videoClarity", video.getVideoClarity());
            
            retList.add(map);
        }
        
        List<List<Map<String, Object>>> resList = new ArrayList<List<Map<String,Object>>>();
        for (int i = 0; i < retList.size(); i += 2) {
            resList.add(retList.subList(i, i+2));
        }

        return resList;
    }
}
